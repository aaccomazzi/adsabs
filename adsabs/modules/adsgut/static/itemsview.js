// Generated by CoffeeScript 1.6.1
(function() {
  var $, ItemView, ItemsFilterView, ItemsView, addwa, addwoa, addwoata, cdict, enval, h, prefix, root, w,
    _this = this,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  $ = jQuery;

  h = teacup;

  w = widgets;

  prefix = GlobalVariables.ADS_PREFIX + '/adsgut';

  cdict = function(fqin, l) {
    var d;
    d = {};
    d[fqin] = l;
    return d;
  };

  enval = function(tag) {
    var ename, title, _ref;
    ename = encodeURIComponent(tag.text);
    if (!tag.url) {
      tag.url = "" + prefix + "/postable/" + this.memberable + "/group:default/filter/html?query=tagname:" + ename + "&query=tagtype:ads/tagtype:tag";
      title = (_ref = tag.title) != null ? _ref : ' data-toggle="tooltip" title="' + tag.title + {
        '"': ''
      };
      tag.id = tag.text;
      tag.text = '<a class="tag-link" ' + title + '" href="' + tag.url + '">' + tag.text + '</a>';
      console.log("taggb", tag);
    }
    return tag;
  };

  addwa = function(tag, cback) {
    var eback, items, tags,
      _this = this;
    tags = [tag.id];
    items = [this.item];
    console.log(items, tags);
    eback = function(xhr, etext) {
      console.log("ERROR", etext);
      return alert('Did not succeed');
    };
    return syncs.submit_tags(items, tags, cback, eback);
  };

  addwoa = function(tag, cback) {
    console.log("NEWTAG", tag);
    this.update_tags(tag.id);
    cback();
    return console.log("NEWTAGS", this.newtags);
  };

  ItemView = (function(_super) {

    __extends(ItemView, _super);

    function ItemView() {
      var _this = this;
      this.submitNote = function() {
        return ItemView.prototype.submitNote.apply(_this, arguments);
      };
      this.update_note_ajax = function(data) {
        return ItemView.prototype.update_note_ajax.apply(_this, arguments);
      };
      this.render = function() {
        return ItemView.prototype.render.apply(_this, arguments);
      };
      this.update_notes = function(newnote) {
        return ItemView.prototype.update_notes.apply(_this, arguments);
      };
      this.update_posts = function(newpost) {
        return ItemView.prototype.update_posts.apply(_this, arguments);
      };
      this.update_tags = function(newtag) {
        return ItemView.prototype.update_tags.apply(_this, arguments);
      };
      this.update = function(postings, notes, tags) {
        return ItemView.prototype.update.apply(_this, arguments);
      };
      return ItemView.__super__.constructor.apply(this, arguments);
    }

    ItemView.prototype.tagName = 'div';

    ItemView.prototype.className = 'itemcontainer';

    ItemView.prototype.events = {
      "click .notebtn": "submitNote"
    };

    ItemView.prototype.initialize = function(options) {
      this.stags = options.stags, this.notes = options.notes, this.item = options.item, this.postings = options.postings, this.memberable = options.memberable, this.noteform = options.noteform, this.tagajaxsubmit = options.tagajaxsubmit;
      console.log("PVIN", this.memberable);
      this.hv = void 0;
      this.newtags = [];
      this.newnotes = [];
      return this.newposts = [];
    };

    ItemView.prototype.update = function(postings, notes, tags) {
      this.stags = tags;
      this.notes = notes;
      return this.postings = postings;
    };

    ItemView.prototype.update_tags = function(newtag) {
      console.log(">>>", newtag);
      return this.newtags.push(newtag);
    };

    ItemView.prototype.update_posts = function(newpost) {
      return this.newposts.push(newpost);
    };

    ItemView.prototype.update_notes = function(newnote) {
      return this.newnotes.push(newnote);
    };

    ItemView.prototype.render = function() {
      var additional, additionalpostings, adslocation, content, fqin, htmlstring, jslist, tagdict, thepostings, thetags, url;
      this.$el.empty();
      adslocation = "http://labs.adsabs.harvard.edu/adsabs/abs/";
      url = adslocation + ("" + this.item.basic.name);
      htmlstring = "<span class='itemtitle'><a href=\"" + url + "\">" + this.item.basic.name + "</a></span><br/>";
      fqin = this.item.basic.fqin;
      content = '';
      content = content + htmlstring;
      thetags = format_tags_for_item(fqin, cdict(fqin, this.stags), this.memberable);
      additional = "<span class='tagls'></span><br/>";
      thepostings = format_postings_for_item(fqin, cdict(fqin, this.postings), this.memberable);
      additionalpostings = "<span class='postls'><strong>In Libraries</strong>: " + (thepostings.join(', ')) + "</span><br/>";
      additional = additional + additionalpostings;
      content = content + additional;
      this.$el.append(content);
      tagdict = {
        values: thetags,
        enhanceValue: _.bind(enval, this),
        addWithAjax: _.bind(addwa, this),
        addWithoutAjax: _.bind(addwoa, this),
        ajax_submit: this.tagajaxsubmit,
        templates: {
          pill: '<span class="badge badge-default tag-badge" style="margin-right:3px;">{0}</span>&nbsp;&nbsp;&nbsp;&nbsp;',
          add_pill: '<span class="label label-info tag-badge" style="margin-right:3px;margin-left:7px;">new tag</span>&nbsp;',
          input_pill: '<span></span>&nbsp;'
        }
      };
      jslist = [];
      this.$('.tagls').tags(jslist, tagdict);
      this.tagsobject = jslist[0];
      console.log("TAGSOBJECT", this.tagsobject);
      if (this.noteform) {
        this.hv = new w.HideableView({
          state: 0,
          widget: w.postalnote_form("make note", 2, 0),
          theclass: ".postalnote"
        });
        this.$el.append(this.hv.render("Notes: ").$el);
        if (this.hv.state === 0) {
          this.hv.hide();
        }
      }
      this.$el.append(format_notes_for_item(fqin, cdict(fqin, this.notes), this.memberable));
      return this;
    };

    ItemView.prototype.update_note_ajax = function(data) {
      var fqin, notes, stags, _ref;
      fqin = this.item.basic.fqin;
      _ref = get_taggings(data), stags = _ref[0], notes = _ref[1];
      this.stags = stags[fqin];
      this.notes = notes[fqin];
      return this.render();
    };

    ItemView.prototype.submitNote = function() {
      var cback, eback, item, loc, notetext,
        _this = this;
      console.log("IN SUBMIT NOTE");
      item = this.item.basic.fqin;
      notetext = this.$('.txt').val();
      console.log(notetext);
      loc = window.location;
      cback = function(data) {
        console.log("return data", data, loc);
        return _this.update_note_ajax(data);
      };
      eback = function(xhr, etext) {
        console.log("ERROR", etext, loc);
        return alert('Did not succeed');
      };
      syncs.submit_note(item, notetext, cback, eback);
      return false;
    };

    return ItemView;

  })(Backbone.View);

  addwoata = function(tag, cback) {
    console.log("IN ADVOATA", tag);
    this.update_tags(tag);
    cback();
    return console.log("NEWTAGS", this.newtags);
  };

  ItemsView = (function(_super) {

    __extends(ItemsView, _super);

    function ItemsView() {
      var _this = this;
      this.submitTags = function() {
        return ItemsView.prototype.submitTags.apply(_this, arguments);
      };
      this.submitPosts = function() {
        return ItemsView.prototype.submitPosts.apply(_this, arguments);
      };
      this.iDone = function() {
        return ItemsView.prototype.iDone.apply(_this, arguments);
      };
      this.render = function() {
        return ItemsView.prototype.render.apply(_this, arguments);
      };
      this.update_tags = function(newtag) {
        return ItemsView.prototype.update_tags.apply(_this, arguments);
      };
      this.update_postings_taggings = function() {
        return ItemsView.prototype.update_postings_taggings.apply(_this, arguments);
      };
      return ItemsView.__super__.constructor.apply(this, arguments);
    }

    ItemsView.prototype.events = {
      "click .post": "submitPosts",
      "click .tag": "submitTags",
      "click .done": "iDone"
    };

    ItemsView.prototype.initialize = function(options) {
      return this.stags = options.stags, this.notes = options.notes, this.$el = options.$el, this.postings = options.postings, this.memberable = options.memberable, this.items = options.items, this.nameable = options.nameable, this.itemtype = options.itemtype, this.loc = options.loc, this.noteform = options.noteform, options;
    };

    ItemsView.prototype.update_postings_taggings = function() {
      var i, itemlist, itemsq,
        _this = this;
      this.postings = {};
      console.log("itys", this.items);
      itemlist = (function() {
        var _i, _len, _ref, _results;
        _ref = this.items;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          i = _ref[_i];
          _results.push("items=" + (encodeURIComponent(i.basic.fqin)));
        }
        return _results;
      }).call(this);
      itemsq = itemlist.join("&");
      return $.get(prefix + ("/items/taggingsandpostings?" + itemsq), function(data) {
        var e, fqin, k, v, _i, _len, _ref, _ref1, _ref2, _results;
        _ref = get_taggings(data), _this.stags = _ref[0], _this.notes = _ref[1];
        _ref1 = data.postings;
        for (k in _ref1) {
          if (!__hasProp.call(_ref1, k)) continue;
          v = _ref1[k];
          if (v[0] > 0) {
            _this.postings[k] = (function() {
              var _i, _len, _ref2, _results;
              _ref2 = v[1];
              _results = [];
              for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
                e = _ref2[_i];
                _results.push(e.thething.postfqin);
              }
              return _results;
            })();
          } else {
            _this.postings[k] = [];
          }
        }
        _ref2 = _this.items;
        _results = [];
        for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
          i = _ref2[_i];
          fqin = i.basic.fqin;
          _this.itemviews[fqin].update(_this.postings[fqin], _this.notes[fqin], _this.stags[fqin]);
          _results.push(_this.itemviews[fqin].render());
        }
        return _results;
      });
    };

    ItemsView.prototype.update_tags = function(newtag) {
      var fqin, i, _i, _len, _ref, _results;
      _ref = this.items;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        i = _ref[_i];
        fqin = i.basic.fqin;
        this.itemviews[fqin].update_tags(newtag.id);
        _results.push(this.itemviews[fqin].tagsobject.addTag(this.itemviews[fqin].$('.pills-list'), newtag));
      }
      return _results;
    };

    ItemsView.prototype.render = function() {
      var $ctrls, $lister, cback, eback, fqin, i, ins, v, _i, _len, _ref,
        _this = this;
      $lister = this.$('.items');
      $ctrls = this.$('.ctrls');
      this.itemviews = {};
      _ref = this.items;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        i = _ref[_i];
        fqin = i.basic.fqin;
        ins = {
          stags: this.stags[fqin],
          notes: this.notes[fqin],
          postings: this.postings[fqin],
          item: i,
          memberable: this.memberable,
          noteform: this.noteform,
          tagajaxsubmit: false
        };
        v = new ItemView(ins);
        $lister.append(v.render().el);
        this.itemviews[fqin] = v;
      }
      eback = function(xhr, etext) {
        console.log("ERROR", etext);
        return alert('Did not succeed');
      };
      cback = function(data) {
        var jslist, libs, tagdict;
        console.log(data);
        libs = _.union(data.libraries, data.groups);
        $ctrls.append(w.postalall_form(_this.nameable, _this.itemtype, libs));
        tagdict = {
          enhanceValue: _.bind(enval, _this),
          addWithAjax: _.bind(addwa, _this),
          addWithoutAjax: _.bind(addwoata, _this),
          ajax_submit: false,
          templates: {
            pill: '<span class="badge badge-default tag-badge" style="margin-right:3px;">{0}</span>&nbsp;&nbsp;&nbsp;&nbsp;',
            add_pill: '<span class="label label-info tag-badge" style="margin-right:3px;margin-left:7px;">new tag</span>&nbsp;',
            input_pill: '<span></span>&nbsp;'
          }
        };
        jslist = [];
        _this.$('#alltags').tags(jslist, tagdict);
        return _this.globaltagsobject = jslist[0];
      };
      syncs.get_postables_writable(this.memberable, cback, eback);
      return this;
    };

    ItemsView.prototype.iDone = function() {
      var cback, eback,
        _this = this;
      cback = function(data) {
        return window.location = _this.loc;
      };
      eback = function(xhr, etext) {
        console.log("ERROR", etext, _this.loc);
        return alert('Did not succeed');
      };
      syncs.save_items(this.items, cback, eback);
      window.close();
      return false;
    };

    ItemsView.prototype.submitPosts = function() {
      var cback, eback, libs, loc, makepublic, postables,
        _this = this;
      libs = this.$('.multilibrary').val();
      if (libs === null) {
        libs = [];
      }
      postables = libs;
      makepublic = this.$('.makepublic').is(':checked');
      if (makepublic) {
        postables = postables.concat(['adsgut/group:public']);
      }
      loc = window.location;
      cback = function(data) {
        return _this.update_postings_taggings();
      };
      eback = function(xhr, etext) {
        console.log("ERROR", etext, loc);
        return alert('Did not succeed');
      };
      syncs.submit_posts(this.items, postables, cback, eback);
      return false;
    };

    ItemsView.prototype.submitTags = function() {
      var cback, e, eback, loc, tags, tagstring,
        _this = this;
      tagstring = this.$('.tagsinput').val();
      if (tagstring === "") {
        console.log("a");
        tags = [];
      } else {
        console.log("b", (function() {
          var _i, _len, _ref, _results;
          _ref = tagstring.split(',');
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            e = _ref[_i];
            _results.push(e);
          }
          return _results;
        })());
        tags = (function() {
          var _i, _len, _ref, _results;
          _ref = tagstring.split(',');
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            e = _ref[_i];
            _results.push(e.trim());
          }
          return _results;
        })();
        tags = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = tags.length; _i < _len; _i++) {
            e = tags[_i];
            if (e !== "") {
              _results.push(e);
            }
          }
          return _results;
        })();
      }
      loc = window.location;
      cback = function(data) {
        _this.$('.tagsinput').val("");
        return _this.update_postings_taggings();
      };
      eback = function(xhr, etext) {
        console.log("ERROR", etext, loc);
        return alert('Did not succeed');
      };
      syncs.submit_tags(this.items, tags, cback, eback);
      return false;
    };

    return ItemsView;

  })(Backbone.View);

  ItemsFilterView = (function(_super) {

    __extends(ItemsFilterView, _super);

    function ItemsFilterView() {
      var _this = this;
      this.render = function() {
        return ItemsFilterView.prototype.render.apply(_this, arguments);
      };
      return ItemsFilterView.__super__.constructor.apply(this, arguments);
    }

    ItemsFilterView.prototype.initialize = function(options) {
      this.stags = options.stags, this.notes = options.notes, this.$el = options.$el, this.postings = options.postings, this.memberable = options.memberable, this.items = options.items, this.nameable = options.nameable, this.itemtype = options.itemtype, this.noteform = options.noteform;
      return console.log("ITEMS", this.items);
    };

    ItemsFilterView.prototype.render = function() {
      var fqin, i, ins, v, _i, _len, _ref;
      console.log("EL", this.$el);
      _ref = this.items;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        i = _ref[_i];
        fqin = i.basic.fqin;
        ins = {
          stags: this.stags[fqin],
          notes: this.notes[fqin],
          postings: this.postings[fqin],
          item: i,
          memberable: this.memberable,
          noteform: this.noteform,
          tagajaxsubmit: true
        };
        console.log("INS", ins);
        v = new ItemView(ins);
        this.$el.append(v.render().el);
        this.$el.append('<hr/>');
      }
      return this;
    };

    return ItemsFilterView;

  })(Backbone.View);

  root.itemsdo = {
    ItemView: ItemView,
    ItemsView: ItemsView,
    ItemsFilterView: ItemsFilterView
  };

}).call(this);
